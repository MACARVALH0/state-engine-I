(()=>{"use strict";var t={d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{rT:()=>f,RE:()=>_,eN:()=>v,Tf:()=>b,zF:()=>x,rg:()=>E,BS:()=>K});const s=t=>class extends t{constructor(...t){super(...t),this.handlers=new Map}createHandler(t,e){this.handlers.set(t,e)}handleEvent(t,e){if(!this.handlers?.has(t))throw new Error(`O handler para eventos do tipo ${t} não existe.`);this.handlers.get(t)(e)}};class i{constructor(){this.listeners=new Map}subscribe(t,...e){e.forEach(e=>{this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)})}unsubscribe(t,...e){e.forEach(e=>this.listeners.get(e)?.delete(t))}notify(t,e){this.listeners.has(t)&&this.listeners.get(t).forEach(s=>s.handleEvent(t,e))}}const r=t=>class extends t{constructor(...t){super(...t),this.eventManager=new i}};class o{constructor(){this.stack=[]}push(t){this.stack.at(-1)?.pause?.(),this.stack.push(t)}pop(){const t=this.stack.pop();return this.stack.at(-1).resume?.(),t}update(t){this.stack.at(-1)?.paused||this.stack.at(-1)?.update?.(t)}renderLast(t){this.stack.at(-1)?.paused||this.stack.at(-1)?.render?.(t)}}class n{constructor(t,e,s,i={}){this.atlas=t,this.tile_w=e,this.tile_h=s,this.cols=this.atlas.width/this.tile_w,this.rows=this.atlas.height/this.tile_h,this.tile_amount=this.cols*this.rows,this.tileset_config=i??{}}defineTiles(t){const e=Object.entries(t);for(const[t,s]of e){if(isNaN(t))continue;const e=Math.abs(0|t);this.tileset_config[e]=s}}}class a{constructor(t,e,s,...i){this.origin_x=0,this.origin_y=0,this.width=Math.abs(t),this.height=Math.abs(e),this.tile_w=i.tile_w?Math.abs(i.tile_w):64,this.tile_h=i.tile_h?Math.abs(i.tile_h):64,this.keep_tile_size_ratio=!0,this.cols=i.cols?Math.ceil(Math.abs(i.cols)):Math.ceil(this.width/this.tile_w),this.rows=i.rows?Math.ceil(Math.abs(i.cols)):Math.ceil(this.height/this.tile_h),this.visualGrid=this.setupVisualGrid(),this.tileset=new n(s??new ImageData,this.tile_w,this.keep_tile_size_ratio?this.tile_w:this.tile_h)}setTileSet(t){try{this.tileset.atlas.src=t,this.tileset.tileset_config={}}catch(e){throw new Error(`Não foi possível definir o caminho '${t}' como fonte para o tileset.`)}}setupVisualGrid(){const t=[];for(let e=0;e<this.rows;e++)t.push(Array.from({length:this.cols},()=>0));return t}getTile(t,e){return this.tiles[t][e]}}const h=d(s,r);class c extends h{constructor(t){console.log(`Criando o objeto "${t}"...`),console.log("Classe de entidade básica, com as seguintes extensões:"),super(),this.name=t,this.initial_routine_functions=[],this.components=new Map,console.log("Nova `Entity` criada.")}has(...t){return t.every(t=>t in this)}}function d(...t){return[...t].reduce((t,e)=>e(t),class{})}function l(...t){const e=[],i=[...t];i.push(s),i.push(r);const o=i.reduce((t,s)=>{const i=s(t);return"function"==typeof i.initialRoutine&&e.push(i.initialRoutine),i},c);return o.prototype.runInitialRoutine=function(){console.log(`Running initial routine on "${this.name}"`),e.forEach(t=>t()),console.log(`O objeto "${this.name}" está pronto.`)},o}function u(t,...e){if("function"!=typeof t)throw new TypeError("`Base` deve ser uma função construtora.");return e.reduce((t,e)=>{if("function"!=typeof e)throw new TypeError("`Mixin` deve ser uma função.");return e(t)},t)}const p=d(t=>class extends t{constructor(...t){super(...t),this.img_path=t.img_path??"/Sprites",this.sprites=new Map}loadImage(t,e,s=!1){if("string"!=typeof e)throw new Error("O nome do arquivo deve ser uma string.");if(this.sprites.has(t))return void console.warn("Uma imagem já foi renderizada sob o id",'"'+t+'".');if(s){const s=e.search(/strip/i);if(s>=0){const i=this.loadStrip(e),r=[];return i.forEach(t=>{const e=new Image;e.src=t,r.push(e)}),this.sprites.set(t.slice(0,s),r),r}}const i=new Image;return i.src=e,this.sprites.set(t,[i]),[i]}loadStrip(t){const e=t.match(/\d{1,3}/g).pop();var s=e.length;const i=t.indexOf(e);var r=Number(e);const o=`${this.img_base_path}/${t.substring(0,i)}`,n=t.substring(i+s,t.length-1),a=new Set;if(i>=0){let i=!1;for(;!i;){const h=o+r+n;this.files.sprites.includes(h)?a.add(h):i=!0,e.toString().length!=(++e).toString()&&(s++,n=t.substring(index_pos+index_len,t.length-1))}}return a.size>0?a:void 0}});class w extends p{constructor(t="Game/Assets",...e){super(...e),this.base_path=t,this.files=this.getPaths()}async getPaths(){const t=this.base_path+"/manifest.json",e=await fetch(t);if(!e.ok)throw new Error("Não foi possível carregar informações de assets.\n"+err);const s=await e.json();return console.log("Arquivo de caminhos de sprites carregado."),s}}class g{constructor(t){this.ctx=t}getImageData(t,e,s,i){return this.ctx.getImageData(t,e,s,i)}cleanScreen(t,e){this.ctx.clearRect(0,0,t,e)}drawImage(t,e,s){t&&this.ctx.drawImage(t,e,s)}}class m{constructor(t,e){const{Renderer:s,ctx:i}=this.getRenderer(t,e);this.renderer=new s(i),this.screen_width=e.width,this.screen_height=e.height,this.entities=new Set}getRenderer(t,e){if("canvas-renderer"==t)return{Renderer:g,ctx:e.getContext("2d")}}register(t){t.has("x","y","texture")&&this.entities.add(t)}getImageData(t,e,s,i){return this.renderer.getImageData(t,e,s,i)}drawImage(t,e,s){this.renderer.drawImage(t,e,s)}update(t){this.renderer.cleanScreen(this.screen_width,this.screen_height);for(let t of this.entities)this.drawImage(t.texture,t.x,t.y)}}const y=t=>class extends t{constructor(){this.x=0,this.y=0,this.color="",this.b_color="",this.points=new Map(points.map(([t,e],s)=>[`p${s}`,[t,e]])),console.log(this.points)}},f=t=>class extends t{constructor(...t){super(...t),console.log("- Animatable")}static initialRoutine(){if(!this.sprites)throw new Error("Não foi possível encontrar os sprites do objeto.\n");if(0==Object.keys(this.sprites).length)throw new Error("Não foi possível encontrar os sprites do objeto.\n")}},_=t=>class extends t{constructor(){this.width=void 0,this.height=void 0,this.scale=1,this.x=void 0,this.y=void 0,this.offset_x=void 0,this.offset_y=void 0,this._f_offset_x=void 0,this._f_offset_y=void 0,this._DataURL_id=0,this._DataURL=null,this._draw_width=0,this._draw_height=0}},v=t=>class extends t{constructor(...t){super(...t),console.log("- Controllable."),this.is_controllable=!0}},b=t=>class extends t{constructor(...t){super(...t),console.log("- Movable"),this.moves=[!1,!1,!1,!1]}},x=t=>class extends t{constructor(...t){super(...t),console.log("- PhysicalObject2D"),this.pos={x:t.x??0,y:t.y??0},this.vel={x:0,y:0},this.acc_x=t.acc_x??0,this.acc_y=t.acc_y??0,this.mass=t.mass??1,this.x_spd=t.x_spd??0,this.y_spd=t.y_spd??0}},M=t=>class extends t{constructor(...t){super(...t),this.x=t.x??0,this.y=t.y??0,this.scale_x=t.scale_x??0,this.scale_y=t.scale_y??0,this.rotation=t.rotation??0}},E=t=>{const e=u(t,M);return class extends e{constructor(...t){super(...t),console.log("- Positional")}}},k=t=>class extends t{constructor(...t){super(...t),this.texture=t.texture_src??void 0}},K=t=>{const e=u(t,k);return class extends e{constructor(...t){super(...t),console.log("- Visible"),this.is_visible=!0}}},N=d(s,r);class S extends N{constructor(t,e,s,i){super(),this.entity_ids=new Set,this.entities=[],this.systems=new Map([["render",new m(i.renderer??"canvas-renderer",s)]]),this.tilemap=[new a(void 0,t,e,{})],this.assetManager=new w,this.paused=!1}addComposedEntity(t,e,...s){try{const i=new e(t,s);i.runInitialRoutine(),this.entities.push(i);for(let[t,e]of this.systems)e.register(i);return i}catch(e){t?console.error(`Não foi possível criar o objeto composto "${t}":\n`,e):console.error("Não foi possível criar o objeto composto:\n",e)}}addComposedEntity1(t,...s){if(this.entity_ids.has(t))throw new Error("Já existe uma entidade com esse identificador.");const{rT:i,RE:r,eN:o,Tf:n,zF:a,rg:h,BS:c}=e,d=new(l(i,r,o,n,a,h,c))(t,...s);this.entity_ids.add(t);for(let[t,e]of this.systems)e.register(d);return d}createShapeEntity(t,...e){const s=2*Math.PI/Math.round(t),i=e.r??32,r=[],o=e.width??i,n=e.height??i;for(let e=1;e<t;e++){const t=s*e,i=s+o*Math.cos(t),a=s+n*Math.sin(t);r.push([i,a])}const a=new(l(y))(r);this.entities.push(a);for(let[t,e]of this.systems)e.register(a);return a}update(t){this.systems.forEach(e=>{e.update(t)})}pause(){this.paused=!0}resume(){this.paused=!1}}const D=d(s,r);class j extends D{constructor(t){if(super(),"object"!=typeof t)throw new Error("O argumento passado para o construtor deve ser um objeto");try{this.canvas=t,this.canvas_width=this.canvas.width,this.canvas_height=this.canvas.height}catch(t){throw new Error(`O argumento do construtor deve ser um elemento \`canvas\` HTML.\n${t}`)}this.sceneManager=new o,this.last_update=void 0,this.loop_id=void 0}createScene(t,e,s){if(this.sceneManager.stack.length>16)throw new Error("O número máximo de cenas foi excedido.");const i=new S(t??this.canvas_width,e??this.canvas_height,this.canvas,s??{});return i.eventManager.subscribe(this,"entity_created"),this.sceneManager.push(i),i}start(){this.last_update=performance.now(),this.update=this.update.bind(this),requestAnimationFrame(this.update)}update(t){const e=(t-this.last_update)/1e3;this.last_update=t,this.sceneManager.update(e),this.loop_id=requestAnimationFrame(this.update)}}const R=new Proxy({up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight",q:"KeyQ",w:"KeyW",e:"KeyE",r:"KeyR",t:"KeyT",y:"KeyY",u:"KeyU",i:"KeyI",o:"KeyO",p:"KeyP",a:"KeyA",s:"KeyS",d:"KeyD",f:"KeyF",g:"KeyG",h:"KeyH",j:"KeyJ",k:"KeyK",l:"KeyL",z:"KeyZ",x:"KeyX",c:"KeyC",v:"KeyV",b:"KeyB",n:"KeyN",m:"KeyM",d0:"Digit0",d1:"Digit1",d2:"Digit2",d3:"Digit3",d4:"Digit4",d5:"Digit5",d6:"Digit6",d7:"Digit7",d8:"Digit8",d9:"Digit9",n0:"Numpad0",n1:"Numpad1",n2:"Numpad2",n3:"Numpad3",n4:"Numpad4",n5:"Numpad5",n6:"Numpad6",n7:"Numpad7",n8:"Numpad8",n9:"Nu",nDivide:"NumpadDivide",nMultiply:"NumpadMultiply",nSubtract:"NumpadSubtract",nAdd:"NumpadAdd",nComma:"NumpadComma",nDecimal:"NumpadDecimal",l_shift:"ShiftLeft",r_shift:"ShiftRight",tab:"Tab",space:"Space",backspace:"Backspace"},{set(){throw new Error("Não é permitido alterar a configuração dos controles predefinidos.")},deleteProperty(){throw new Error("Não é permitido deletar propriedades dos controles predefinidos.")}}),I=Object.entries(R).map(([t,e])=>[e,!1]),O=new Map(I);function A(t,e){if(t.repeat)return;const s=t.code;O.set(s,e)}const L=new Proxy(new class{constructor(){this.eventManager=new i,this.onKeyDown=t=>{A(t,!0)},this.onKeyUp=t=>{A(t,!1)}}startGlobalListener(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp)}finishGlobalListener(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}check(t){return O.get(t)}update_key_state(t,e){O.set(t,e)}},{set(t,e,s){throw new Error("As propriedades na instância de `Keyboard` não devem ser alteradas.")}}),P=d(s,r);new Proxy(new class extends P{constructor(){super(),this.keyboard=L,this.game,this.sound}createGame(t){if(this.game)throw new Error("Uma instância de `Game` já existe.");const e=new j(t??document.querySelector("canvas")??document.createElement("canvas"));try{this.keyboard.eventManager.subscribe(e,"key_down","key_up","key_pressed"),this.keyboard.startGlobalListener()}catch(t){throw new Error(`Houve um problema na criação do objeto \`Game\`.\nMotivo:\n${t}`)}return this.game=e,this.game}},{set(t,e,s){if("keyboard"==e)throw new Error("Não é possível alterar a configuração do teclado predefinido.");return"game"==e&&t.keyboard.eventManager.unsubscribe(t.game,"key_down","key_up","key_pressed"),t[e]=s,!0}})})();